<% enrolled = local_assigns.fetch(:enrolled, true) %>

<div class="flex h-full flex-col">
  <% if course.cover_image.attached? %>
    <% thumb = (course.cover_image.variant(resize_to_fill: [2000, 1125]).processed rescue nil) %>
    <div class="relative overflow-hidden rounded-none bg-black lg:rounded-l-none">
      <% if thumb %>
        <%= image_tag thumb, class: "h-[38vh] w-full object-cover opacity-95 md:h-[45vh]" %>
      <% else %>
        <%= image_tag rails_blob_path(course.cover_image, disposition: "inline"), class: "h-[38vh] w-full object-cover opacity-95 md:h-[45vh]" %>
      <% end %>

      <div class="absolute inset-x-0 bottom-0">
        <div class="h-28 bg-gradient-to-t from-black/80 to-transparent"></div>
        <div class="absolute inset-x-0 bottom-0 p-6">
          <div class="text-center">
            <div class="text-3xl font-extrabold tracking-tight text-white md:text-4xl"><%= course.name.to_s.upcase %></div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="rounded-2xl border border-gray-200 bg-white p-8 shadow-sm">
      <div class="text-center text-3xl font-extrabold tracking-tight text-gray-900 md:text-4xl"><%= course.name.to_s.upcase %></div>
    </div>
  <% end %>

  <div class="flex-1 overflow-y-auto bg-white">
    <div class="mx-auto max-w-3xl px-6 py-8">
      <% if course.description&.body&.present? %>
        <div class="text-gray-800"><%= course.description %></div>
      <% else %>
        <p class="text-gray-500">Popis brzy doplníme.</p>
      <% end %>

      <% if enrolled %>
        <div class="mt-8 rounded-2xl border border-gray-200 bg-gray-50 p-5 text-sm text-gray-700">
          Vyberte segment vlevo pro přehrání videa.
        </div>
      <% else %>
        <div class="mt-8 rounded-2xl border border-gray-200 bg-gray-50 p-5">
          <div class="text-sm font-semibold text-gray-900">Kurz ještě nemáte zakoupený.</div>
          <div class="mt-2 flex flex-wrap items-center justify-between gap-3">
            <div class="text-sm text-gray-600">
              Cena: <span class="font-semibold text-gray-900"><%= number_to_currency(course.price, unit: course.currency, precision: course.display_precision) %></span>
            </div>
            <%= button_to "Koupit nyní",
                          cart_items_path(course_id: course.id),
                          method: :post,
                          data: { turbo: false, turbo_submits_with: "Přidávám..." },
                          class: "inline-flex items-center justify-center rounded-xl bg-gray-900 px-4 py-2.5 text-sm font-semibold text-white hover:bg-black" %>
          </div>
        </div>

        <% if course.chapters.any? %>
          <div class="mt-8">
            <h2 class="text-lg font-semibold text-gray-900">Obsah kurzu</h2>
            <div class="mt-4 space-y-3">
              <% course.chapters.each do |chapter| %>
                <div class="rounded-2xl border border-gray-200 bg-white">
                  <div class="px-4 py-3 text-sm font-semibold text-gray-900"><%= chapter.title %></div>
                  <% if chapter.segments.any? %>
                    <div class="border-t border-gray-100">
                      <% chapter.segments.each do |segment| %>
                        <div class="flex items-center justify-between gap-3 border-b border-gray-50 px-4 py-2.5 last:border-b-0">
                          <% if segment.is_free_preview? %>
                            <%= link_to course_chapter_segment_path(course, chapter, segment),
                                        class: "flex items-center gap-2 text-sm font-medium text-gray-900 hover:underline" do %>
                              <svg class="h-4 w-4 shrink-0 text-emerald-600" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M6.3 2.84A1.5 1.5 0 0 0 4 4.11v11.78a1.5 1.5 0 0 0 2.3 1.27l9.344-5.891a1.5 1.5 0 0 0 0-2.538L6.3 2.841Z" />
                              </svg>
                              <span><%= segment.title %></span>
                            <% end %>
                            <span class="shrink-0 rounded-full bg-emerald-100 px-2 py-0.5 text-[10px] font-semibold text-emerald-800">Zdarma</span>
                          <% else %>
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                              <svg class="h-4 w-4 shrink-0" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 0 0-4.5 4.5V9H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-.5V5.5A4.5 4.5 0 0 0 10 1Zm3 8V5.5a3 3 0 1 0-6 0V9h6Z" clip-rule="evenodd" />
                              </svg>
                              <span><%= segment.title %></span>
                            </div>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
